name: Build and Deploy

on:
  push:
    branches: [ LeshaCiCd ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Display project structure
      run: |
        ls -la
        echo "-------------------------------"
        find . -type f -name "wait-for-db.sh" -o -name "*.dockerfile" -o -name "Dockerfile*"
        echo "-------------------------------"
        find . -type d -name "TG_miniApp_*"

    - name: Generate Docker Compose file
      run: |
        cat > docker-compose.yml << 'EOF'
        version: '3'

        services:
          db:
            image: postgres:16
            volumes:
              - postgres_data:/var/lib/postgresql/data
            environment:
              - POSTGRES_PASSWORD=footbot777Azat
              - POSTGRES_USER=postgres
              - POSTGRES_DB=mydb
            # –ù–µ –ø—É–±–ª–∏–∫—É–µ–º –ø–æ—Ä—Ç –Ω–∞—Ä—É–∂—É, –∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é —Å–µ—Ç—å
            # ports:
            #  - "5432:5432"
            expose:
              - "5432"
            networks:
              - app-network
            healthcheck:
              test: ["CMD-SHELL", "pg_isready -U postgres"]
              interval: 5s
              timeout: 5s
              retries: 5

          nginx:
            image: nginx:alpine
            ports:
              - "8080:80"
              - "8443:443"
            volumes:
              - ./nginx/conf:/etc/nginx/conf.d
              - ./nginx/ssl:/etc/nginx/ssl
              - ./nginx/logs:/var/log/nginx
            depends_on:
              - backend
              - frontend
            networks:
              - app-network
            restart: always

          backend:
            build: 
              context: .
              dockerfile: Dockerfile.backend
            ports:
              - "5001:5001"
            environment:
              - FLASK_ENV=production
              - FLASK_DEBUG=0
              - DATABASE_URL=postgresql://postgres:footbot777Azat@db/mydb
              - BOT_TOKEN=${BOT_TOKEN}
            depends_on:
              db:
                condition: service_healthy
            networks:
              - app-network
            restart: unless-stopped

          frontend:
            build:
              context: .
              dockerfile: Dockerfile.frontend
            ports:
              - "5173:5173"
            depends_on:
              - backend
            environment:
              - VITE_API_URL=https://www.findyoursport.ru/api
            networks:
              - app-network
            restart: unless-stopped

        networks:
          app-network:
            driver: bridge

        volumes:
          postgres_data:
        EOF

    - name: Generate Nginx Config
      run: |
        mkdir -p nginx/conf
        cat > nginx/conf/default.conf << 'EOF'
        server {
            listen 80;
            server_name www.findyoursport.ru findyoursport.ru;
            
            # –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –±–æ–ª—å—à–∏—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –¥–ª—è Telegram WebApp
            client_max_body_size 10M;
            large_client_header_buffers 4 32k;
            
            # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Telegram
            add_header X-Frame-Options "ALLOW-FROM https://telegram.org";
            add_header Content-Security-Policy "frame-ancestors 'self' https://telegram.org https://*.telegram.org";
            
            location / {
                proxy_pass http://frontend:5173;
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection 'upgrade';
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_cache_bypass $http_upgrade;
            }
            
            location /api/ {
                proxy_pass http://backend:5001/api/;
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection 'upgrade';
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                
                # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç—ã –¥–ª—è API –∑–∞–ø—Ä–æ—Å–æ–≤
                proxy_connect_timeout 300s;
                proxy_send_timeout 300s;
                proxy_read_timeout 300s;
            }
        }
        EOF

    - name: Create archive of project
      run: |
        cat > wait-for-db.sh << 'EOF'
        #!/bin/bash
        set -e
        
        host="$1"
        port="$2"
        
        echo "Waiting for PostgreSQL at $host:$port..."
        
        until nc -z -v -w30 "$host" "$port"; do
          echo "PostgreSQL is not available yet - sleeping"
          sleep 2
        done
        
        echo "PostgreSQL is up - continuing"
        EOF
        
        chmod +x wait-for-db.sh
        
        tar -czvf project.tar.gz Dockerfile.backend Dockerfile.frontend TG_miniApp_back TG_miniApp_front wait-for-db.sh

    - name: Copy files to server
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.SERVER_IP }}
        username: ${{ secrets.USERNAME }}
        password: ${{ secrets.SERVER_PASSWORD }}
        source: "docker-compose.yml,nginx/conf/default.conf,project.tar.gz"
        target: "/home/footbot"
        strip_components: 0

    - name: Deploy to server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_IP }}
        username: ${{ secrets.USERNAME }}
        password: ${{ secrets.SERVER_PASSWORD }}
        script: |
          echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è Docker..."
          if ! command -v docker &> /dev/null; then
            echo "Docker –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º..."
            sudo apt-get update
            sudo apt-get install -y apt-transport-https ca-certificates curl software-properties-common
            curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
            sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
            sudo apt-get update
            sudo apt-get install -y docker-ce
          fi
          
          echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è Docker Compose..."
          if ! command -v docker-compose &> /dev/null; then
            echo "Docker Compose –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º..."
            sudo apt-get update
            sudo apt-get install -y docker-compose
          fi
          
          mkdir -p /home/footbot/nginx/conf /home/footbot/nginx/ssl /home/footbot/nginx/logs
          cd /home/footbot
          
          if [ ! -f docker-compose.yml ]; then
            echo "–û–®–ò–ë–ö–ê: docker-compose.yml –Ω–µ –Ω–∞–π–¥–µ–Ω!"
            exit 1
          fi
          
          echo "–†–∞—Å–ø–∞–∫–æ–≤–∫–∞ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–æ–¥–∞..."
          tar -xzvf project.tar.gz
          
          echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏:"
          ls -la
          
          echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –≤—Å–µ—Ö –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —Ñ–∞–π–ª–æ–≤..."
          if [ ! -f Dockerfile.backend ]; then echo "–û–®–ò–ë–ö–ê: Dockerfile.backend –Ω–µ –Ω–∞–π–¥–µ–Ω!"; exit 1; fi
          if [ ! -f Dockerfile.frontend ]; then echo "–û–®–ò–ë–ö–ê: Dockerfile.frontend –Ω–µ –Ω–∞–π–¥–µ–Ω!"; exit 1; fi
          if [ ! -f wait-for-db.sh ]; then echo "–û–®–ò–ë–ö–ê: wait-for-db.sh –Ω–µ –Ω–∞–π–¥–µ–Ω!"; exit 1; fi
          if [ ! -d TG_miniApp_back ]; then echo "–û–®–ò–ë–ö–ê: TG_miniApp_back –Ω–µ –Ω–∞–π–¥–µ–Ω!"; exit 1; fi
          if [ ! -d TG_miniApp_front ]; then echo "–û–®–ò–ë–ö–ê: TG_miniApp_front –Ω–µ –Ω–∞–π–¥–µ–Ω!"; exit 1; fi
          
          echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–Ω—è—Ç–æ—Å—Ç–∏ –ø–æ—Ä—Ç–æ–≤..."
          echo "–ü–æ—Ä—Ç 5432 (PostgreSQL):"
          sudo netstat -tulpn | grep 5432 || echo "–ü–æ—Ä—Ç 5432 —Å–≤–æ–±–æ–¥–µ–Ω"
          echo "–ü–æ—Ä—Ç 80 (HTTP):"
          sudo netstat -tulpn | grep 80 || echo "–ü–æ—Ä—Ç 80 —Å–≤–æ–±–æ–¥–µ–Ω"
          echo "–ü–æ—Ä—Ç 443 (HTTPS):"
          sudo netstat -tulpn | grep 443 || echo "–ü–æ—Ä—Ç 443 —Å–≤–æ–±–æ–¥–µ–Ω"
          
          echo "–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –∑–∞–ø—É—â–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
          docker stop $(docker ps -aq) || true
          docker rm $(docker ps -aq) || true
          
          echo "–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤, –µ—Å–ª–∏ –æ–Ω–∏ –∑–∞–ø—É—â–µ–Ω—ã..."
          # –ï—Å–ª–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ —É–∂–µ –µ—Å—Ç—å PostgreSQL, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –µ–≥–æ
          sudo systemctl stop postgresql.service || true
          # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ Nginx –¥–ª—è –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è –ø–æ—Ä—Ç–æ–≤
          echo "–û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ Nginx..."
          sudo systemctl stop nginx || true
          
          echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –Ω–∞ —Å–∫—Ä–∏–ø—Ç–µ wait-for-db.sh..."
          chmod +x wait-for-db.sh
          
          if [ ! -f nginx/ssl/fullchain.pem ]; then
            echo "–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤..."
            sudo find /etc/letsencrypt/live/ -type d -name "findyoursport.ru*" || echo "–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
            sudo find /etc/letsencrypt/live/ -type f -name "*.pem" || echo "–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
            
            if [ -f /etc/letsencrypt/live/findyoursport.ru/fullchain.pem ]; then
              sudo cp /etc/letsencrypt/live/findyoursport.ru/fullchain.pem nginx/ssl/
              sudo cp /etc/letsencrypt/live/findyoursport.ru/privkey.pem nginx/ssl/
            elif [ -f /etc/letsencrypt/live/www.findyoursport.ru/fullchain.pem ]; then
              sudo cp /etc/letsencrypt/live/www.findyoursport.ru/fullchain.pem nginx/ssl/
              sudo cp /etc/letsencrypt/live/www.findyoursport.ru/privkey.pem nginx/ssl/
            else
              echo "–í–ù–ò–ú–ê–ù–ò–ï: –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—É—Ç–∏ –∫ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º."
            fi
            
            sudo chmod -R 755 nginx/ssl
          fi
          
          echo "–í—ã–≤–æ–¥ –≤–µ—Ä—Å–∏–π Docker –∏ Docker Compose:"
          docker --version
          docker-compose --version
          
          echo "–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –µ—Å–ª–∏ –æ–Ω–∏ –∑–∞–ø—É—â–µ–Ω—ã..."
          docker-compose down || true
          
          echo "–£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–∑—ã..."
          docker system prune -af || true
          
          echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —Ñ–∞–π–ª–∞ docker-compose.yml:"
          cat docker-compose.yml
          
          echo "–°–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
          # –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ docker-compose
          export BOT_TOKEN="${{ secrets.BOT_TOKEN }}"
          
          # –ù–ï –æ—á–∏—â–∞–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –¥–µ–ø–ª–æ–µ
          echo "üü¢ –í–ù–ò–ú–ê–ù–ò–ï: –†–µ–∂–∏–º –æ—á–∏—Å—Ç–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –û–¢–ö–õ–Æ–ß–ï–ù! üü¢"
          export RESET_DB=false
          
          docker-compose build --no-cache
          docker-compose up -d
          
          echo "–°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:"
          docker-compose ps
          
          # –û–∂–∏–¥–∞–µ–º –Ω–µ–±–æ–ª—å—à—É—é –ø–∞—É–∑—É –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
          sleep 10
          
          echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –∏ –ø–æ—Ä—Ç–æ–≤:"
          netstat -tulpn | grep -E '5001|5173|5432|80|443|8080|8443' || echo "–ù–µ—Ç –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–µ–º—ã—Ö –ø–æ—Ä—Ç–æ–≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"
          
          echo "–õ–æ–≥–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:"
          docker-compose logs db
          
          echo "–õ–æ–≥–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –±—ç–∫–µ–Ω–¥–∞:"
          docker-compose logs backend
          
          echo "–õ–æ–≥–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ nginx:"
          docker-compose logs nginx
          
          echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ç–µ–≤—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –º–µ–∂–¥—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏:"
          docker network ls | grep app-network || echo "–°–µ—Ç—å app-network –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"
          docker network inspect footbot_app-network || true
          
          echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±—ç–∫–µ–Ω–¥—É:"
          curl -v http://localhost:5001/api/users || echo "–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ API –±—ç–∫–µ–Ω–¥–∞"
          
          echo "–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ Nginx..."
          sudo systemctl restart nginx || true
          echo "–°—Ç–∞—Ç—É—Å Nginx:"
          sudo systemctl status nginx || true
          
          echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
          echo "–§—Ä–æ–Ω—Ç–µ–Ω–¥ (—á–µ—Ä–µ–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä):"
          curl -s http://localhost:5173 > /dev/null && echo "–§—Ä–æ–Ω—Ç–µ–Ω–¥ –¥–æ—Å—Ç—É–ø–µ–Ω" || echo "–§—Ä–æ–Ω—Ç–µ–Ω–¥ –ù–ï –¥–æ—Å—Ç—É–ø–µ–Ω"
          
          echo "–ë—ç–∫–µ–Ω–¥ (–Ω–∞–ø—Ä—è–º—É—é):"
          curl -s http://localhost:5001/api/users > /dev/null && echo "–ë—ç–∫–µ–Ω–¥ –¥–æ—Å—Ç—É–ø–µ–Ω" || echo "–ë—ç–∫–µ–Ω–¥ –ù–ï –¥–æ—Å—Ç—É–ø–µ–Ω"
          
          echo "–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Nginx (–±–µ–∑ SSL):"
          curl -s http://localhost:8080 > /dev/null && echo "–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Nginx –¥–æ—Å—Ç—É–ø–Ω–æ" || echo "–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Nginx –ù–ï –¥–æ—Å—Ç—É–ø–Ω–æ"
          
          echo "–î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø–æ –∞–¥—Ä–µ—Å—É: http://findyoursport.ru:8080"
