# FootBot Backend

Этот проект является backend частью приложения FootBot (Telegram Mini App). Он реализован с использованием Flask, Flask-SQLAlchemy, Flask-Migrate и Flask-Cors. В данном документе описаны основные эндпоинты API, функционал и алгоритмы работы приложения.

## Содержание

- [Установка и запуск](#установка-и-запуск)
- [Структура проекта](#структура-проекта)
- [API эндпоинты](#api-эндпоинты)
  - [Пользователи](#пользователи)
  - [Игровые комнаты](#игровые-комнаты)
  - [История игр](#история-игр)
  - [Локации](#локации)
  - [Прочее](#прочее)
- [Команды Flask CLI](#команды-flask-cli)
- [Логика обновления статистики и начисления очков](#логика-обновления-статистики-и-начисления-очков)
- [Примечания](#примечания)
- [Контакты и поддержка](#контакты-и-поддержка)

## Установка и запуск

1. **Установка зависимостей:**
   Установите все необходимые зависимости командой:
   ```bash
   pip install -r requirements.txt
   ```

2. **Настройка переменной окружения для базы данных:**
   Задайте переменную окружения `DATABASE_URL` для подключения к базе данных (например, PostgreSQL):
   ```bash
   export DATABASE_URL=postgresql://username:password@localhost:5432/your_database
   ```
   *(В Windows используйте: `set DATABASE_URL=postgresql://username:password@localhost:5432/your_database`)*

3. **Инициализация базы данных:**
   Для создания всех необходимых таблиц и добавления тестовых данных выполните команду:
   ```bash
   flask init-db
   ```
   Либо запустите скрипт `init_db.py`.

4. **Запуск сервера:**
   Запустите приложение командой:
   ```bash
   python main.py
   ```
   По умолчанию сервер запускается на порту 5001.

## Структура проекта

- **main.py:** Основной файл приложения, содержащий все эндпоинты API, модели данных и бизнес-логику.
- **check_db.py:** Скрипт для проверки доступности и корректности таблиц в базе данных.
- **init_db.py:** Скрипт для инициализации базы данных, создания таблиц и добавления тестовых пользователей.
- **locations.py:** Модуль для работы с локациями. Содержит функции для поиска локаций и получения полного списка.

## API эндпоинты

### Пользователи

- **GET /api/users**
  - Возвращает список всех пользователей.

- **GET /api/users/<user_id>**
  - Возвращает информацию о конкретном пользователе по его идентификатору.

- **GET /api/users/me**
  - Возвращает информацию о текущем пользователе. Если текущий пользователь не установлен, выбирается первый пользователь из базы данных.

- **POST /api/users/set-current/<user_id>**
  - Устанавливает текущего пользователя для тестирования. (Также доступен эндпоинт **/api/users/switch/<user_id>** для переключения пользователя.)

- **POST /api/users/theme-preference**
  - Устанавливает предпочтение темы ("light" или "dark") для текущего пользователя.

- **GET /api/leaderboard**
  - Возвращает таблицу лидеров с информацией о пользователях, их очках, сыгранных играх и статистикой. Поддерживается пагинация.

### Игровые комнаты

- **GET /api/game-rooms**
  - Возвращает список доступных игровых комнат. Комнаты со статусом `completed` и заполненные комнаты не включаются в результат.

- **GET /api/game-rooms/<room_id>**
  - Возвращает детальную информацию о конкретной игровой комнате.

- **POST /api/game-rooms**
  - Создает новую игровую комнату. Параметры запроса включают `name`, `location`, `timeRange` и опционально `maxPlayers`.

- **POST /api/game-rooms/<room_id>/join**
  - Позволяет пользователю присоединиться к игровой комнате. Перед присоединением происходит проверка:
    - Заполненности комнаты
    - Нахождения пользователя в другой активной комнате (статус не `completed`)

- **POST /api/game-rooms/<room_id>/leave**
  - Позволяет пользователю покинуть игровую комнату. Если пользователь является создателем, то права создаются для другого игрока случайным образом.

- **DELETE /api/game-rooms/<room_id>**
  - Удаляет игровую комнату. Эту операцию может выполнить только создатель комнаты.

- **POST /api/game-rooms/<room_id>/start-team-selection**
  - Инициирует процесс распределения игроков по командам. Игроки распределяются случайным образом, и назначаются капитаны команд.

- **POST /api/game-rooms/<room_id>/start-game**
  - Начинает игру, изменяя статус комнаты на `in_progress` и фиксируя время начала игры.

- **POST /api/game-rooms/<room_id>/end-game**
  - Завершает игру, изменяя статус комнаты на `score_submission` и фиксируя время окончания. Операцию могут выполнить как создатель, так и капитаны команд.

- **POST /api/game-rooms/<room_id>/submit-score**
  - Эндпоинт для ввода счета от капитанов. Формат счета: `X:Y` (например, "3:2").
  - Если оба капитана вводят идентичный счет, игра завершается, и обновляются статистики всех участников.
  - При несовпадении счета происходит увеличение счетчика попыток (`score_submission_attempts`). После трех неудачных попыток вводится ничья и применяются штрафы.

- **POST /api/game-rooms/<room_id>/report-player**
  - Позволяет отправить жалобу на другого игрока, если тот участвует в данной игровой комнате.

### История игр

- **GET /api/users/game-history**
  - Возвращает историю игр текущего пользователя с поддержкой пагинации.

- **GET /api/users/<user_id>/game-history**
  - Возвращает историю игр для конкретного пользователя по его идентификатору.

### Локации

- **GET /api/locations/search?query=...**
  - Выполняет поиск локаций по заданному запросу. Возвращает максимум 10 результатов для предотвращения перегрузки.

- **GET /api/locations**
  - Возвращает полный список доступных локаций.

### Прочее

- **GET /api/user-active-rooms**
  - Возвращает список активных игровых комнат, в которых находится текущий пользователь (исключая завершенные комнаты).

## Команды Flask CLI

- **flask init-db**
  - Инициализирует базу данных: создаются все таблицы и добавляются тестовые пользователи. Также производится проверка доступности таблиц.

## Логика обновления статистики и начисления очков

При завершении игры и подтверждении счета:

- Определяется победившая команда (на основе сравнения счетов).
- Вычисляется ожидаемая вероятность победы на основе среднего рейтинга игроков в команде.
- Игрокам начисляются очки за победу или назначаются штрафы за поражение с учетом индивидуального вклада.
- При наличии несовпадения счетов между капитанами увеличивается счетчик попыток. При достижении лимита (3 попытки) игра завершается с ничьей и применяется штрафная система.

## Примечания

- Эндпоинты для установки текущего пользователя (`/api/users/set-current/<user_id>` и `/api/users/switch/<user_id>`) используются для тестирования. В продакшн-версии эти эндпоинты должны быть защищены или удалены.
- В реальном приложении следует реализовать полноценную аутентификацию (например, через Telegram), а не использовать глобальную переменную `current_user_id`.
- Все эндпоинты возвращают ответы в формате JSON.

## Контакты и поддержка

Если у вас есть вопросы или предложения по улучшению проекта, пожалуйста, создайте issue в репозитории или свяжитесь с разработчиками.

---

Спасибо за использование FootBot Backend! 